<PagePermission>
  {{#if this.loading}}
    <div class="empty">
      <LoadingIcon />
    </div>
  {{else}}
    <div class="header">
      <PowerSelect
        data-test-customer-selection
        @tagName="div"
        class="header-item"
        @options={{this.customers}}
        @placeholder="Select customer..."
        @searchField="name"
        @onChange={{this.handleCustomerChange}}
        @selected={{this.selectedCustomer}}
        @allowClear={{true}}
        as |customer|
      >
        <div>{{customer.name}}</div>
      </PowerSelect>
      <PowerSelect
        data-test-project-selection
        @tagName="div"
        class="header-item"
        @options={{this.filteredProjects}}
        placeholder="Select project..."
        @searchField="name"
        @onChange={{this.handleProjectChange}}
        @selected={{this.selectedProject}}
        @allowClear={{true}}
        @disabled={{not this.selectedCustomer}}
        as |project|
      >
        <div>{{project.name}}</div>
      </PowerSelect>
    </div>
    {{#if this.selectedProject}}
      <h3>
        <span class="header-left">
          Tasks of
          {{this.selectedProject.name}}
        </span>
        <span class="header-right">
          <button
            class="btn btn-primary"
            data-test-add-task
            type="button"
            {{on "click" (perform this.createTask)}}
          >Add Task</button>
        </span>
      </h3>
      <div class="task-table-container">
        <EmberScrollable @class="projects-scrollable-container">
          <table
            class="table table--striped table--projects"
            data-test-tasks-table
          >
            <thead>
              <tr>
                <th>Name</th>
                <th>Reference</th>
                <th>Estimated time</th>
                <th>Archived</th>
              </tr>
            </thead>
            <tbody>
              {{#each this.tasks as |task|}}
                <tr
                  class="pointer {{if (eq this.selectedTask task) 'selected'}}"
                  {{! template-lint-disable }}
                  {{on "click" (fn (mut this.selectedTask) task)}}
                  data-test-task-table-row
                >
                  <td data-test-table-name>{{task.name}}</td>
                  <td data-test-table-reference>{{if
                      task.reference
                      task.reference
                      "-"
                    }}</td>
                  <td data-test-table-estimated-time>{{if
                      task.estimatedTime
                      (humanize-duration task.estimatedTime)
                      "-"
                    }}</td>
                  <td><SyCheckmark
                      data-test-table-archived
                      @checked={{task.archived}}
                    /></td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        </EmberScrollable>
      </div>
      {{#if this.selectedTask}}
        <div class="task-form-container" data-test-task-form>
          <h2>{{if
              this.selectedTask.isNew
              "Add task"
              this.selectedTask.name
            }}</h2>
          <ValidatedForm
            @model={{changeset this.selectedTask this.TaskValidations}}
            @on-submit={{perform this.saveTask}}
            as |f|
          >
            <div class="task-form-container-row">
              <div class="task-form-container-column">
                <f.input
                  @label="Name"
                  @name="name"
                  data-test-name
                  @required={{true}}
                />
                <f.input
                  @label="Reference"
                  @name="reference"
                  data-test-reference
                  @required={{false}}
                />
              </div>
              <div class="task-form-container-column">
                <f.input @name="estimatedTime" as |fi|>
                  <label>
                    Estimated time
                  </label>
                  <SyDurationpicker
                    data-test-estimated-time={{true}}
                    @value={{fi.value}}
                    @onChange={{fi.update}}
                  />
                </f.input>

                <f.input @name="archived" as |fi|>
                  <label>
                    Archived
                  </label>
                  <SyCheckbox
                    data-test-archived
                    @checked={{this.selectedTask.archived}}
                    @value={{fi.value}}
                    @onChange={{fi.update}}
                  />
                </f.input>
              </div>
            </div>
            <div class="btn-toolbar btn-toolbar--right">
              <button
                class="btn btn-primary"
                data-test-cancel
                type="button"
                {{on "click" (fn (mut this.selectedTask) null)}}
              >Cancel</button>
              <f.submit data-test-save @disabled={{f.model.isInvalid}} />
            </div>
          </ValidatedForm>
        </div>
      {{/if}}
    {{else}}
      <div class="empty" data-test-none-selected>
        <div>
          {{fa-icon "search"}}
          <h3>Please select a customer and a project</h3>
        </div>
      </div>
    {{/if}}
  {{/if}}
</PagePermission>
